sequence:
  - variables:
      cooling_day_start_time: "08:00:00"
      cooling_day_setpoint_c: 23.5
      cooling_night_setpoint_c: 21
      cooling_night_start_time: "19:00:00"
      cooling_work_setpoint_c: 25
      heating_day_start_time: "07:00:00"
      heating_day_setpoint_c: 21.5
      heating_evening_setpoint_c: 19
      heating_evening_start_time: "19:00:00"
      heating_night_setpoint_c: 16
      heating_night_start_time: "22:00:00"
      heating_work_setpoint_c: 16
      seasonal_mode_switch_temp_c: 10
      forecast_high_warm_threshold_c: 15
      forecast_low_warm_threshold_c: 5
    alias: Initialize Temperature and Schedule Variables
  - choose:
      - conditions:
          - condition: state
            entity_id: binary_sensor.family_status
            state: "off"
        sequence:
          - action: climate.turn_off
            metadata: {}
            data: {}
            target:
              entity_id: climate.nest_learning_thermostat
            alias: Turn Off HVAC (Family Away)
        alias: If Family Status is Away → Turn Off HVAC
      - conditions:
          - condition: state
            entity_id: weather.winnipeg_forecast
            state: unavailable
            alias: If Weather Data Unavailable
        sequence:
          - action: climate.turn_off
            metadata: {}
            data: {}
            target:
              entity_id: climate.nest_learning_thermostat
            alias: Turn Off HVAC (Weather Data Unavailable)
        alias: If Weather Data Unavailable → Turn Off HVAC
    default:
      - alias: Determine HVAC Mode and Temperature Based on Outside Temperature
        if:
          - alias: Check If Outside Temperature is Warm (Above Seasonal Mode Switch Threshold)
            condition: template
            value_template: >-
              {{ states('sensor.winnipeg_temperature') | float >
              seasonal_mode_switch_temp_c }}
        then:
          - alias: Apply Cooling Strategy
            choose:
              - conditions:
                  - condition: numeric_state
                    entity_id: sensor.winnipeg_temperature
                    below: sensor.nest_learning_thermostat_temperature
                    alias: Check If Outside Temperature is Below Inside Temperature
                sequence:
                  - alias: Notify to Open Windows When Natural Cooling is Possible
                    if:
                      - condition: device
                        device_id: d9dd33299705b38f6cd49a948c1bbd19
                        domain: climate
                        entity_id: 4e971f8b9c7a08e3417bd5b5e6c271e0
                        type: is_hvac_mode
                        hvac_mode: cool
                        alias: Check If Nest Learning Thermostat is Currently in COOL Mode
                      - alias: Check If Indoor Temperature is Above Cooling Night Setpoint
                        condition: template
                        value_template: >-
                          {{
                          states('sensor.nest_learning_thermostat_temperature')
                          | float > cooling_night_setpoint_c }}
                    then:
                      - data:
                          title: Open windows to cool house
                          message: >-
                            AC is off. Outdoor temp ({{
                            states('sensor.winnipeg_temperature') | float |
                            round(1) }}°C) is lower than indoor ({{
                            states('sensor.nest_learning_thermostat_temperature')
                            | float | round(1) }}°C), which is also above
                            desired temp ({{ cooling_night_setpoint_c }}°C).
                        action: notify.mobile_app_vadimiphone
                        alias: Send SMS Notification to Open Windows for Natural Cooling
                  - action: climate.turn_off
                    metadata: {}
                    data: {}
                    target:
                      entity_id: climate.nest_learning_thermostat
                    alias: Turn Off HVAC (Natural Cooling Available)
                alias: Outside Cooler than Inside → Turn Off HVAC for Natural Cooling
              - conditions:
                  - condition: state
                    entity_id: binary_sensor.worktime_sensor
                    state: "on"
                sequence:
                  - target:
                      entity_id: climate.nest_learning_thermostat
                    data:
                      temperature: "{{ cooling_work_setpoint_c }}"
                      hvac_mode: cool
                    action: climate.set_temperature
                    alias: Set HVAC to Cooling Mode at {{ cooling_work_setpoint_c }}°C
                alias: During Worktime → Set HVAC to Cooling Work Setpoint ({{ cooling_work_setpoint_c }}°C)
              - conditions:
                  - alias: Check If Current Time is in Cooling Night Schedule
                    condition: template
                    value_template: >-
                      {{ now().strftime('%H:%M:%S') >= cooling_night_start_time
                      or now().strftime('%H:%M:%S') < cooling_day_start_time }}
                sequence:
                  - target:
                      entity_id: climate.nest_learning_thermostat
                    data:
                      temperature: "{{ cooling_night_setpoint_c }}"
                      hvac_mode: cool
                    action: climate.set_temperature
                    alias: Set HVAC to Cooling Mode at {{ cooling_night_setpoint_c }}°C
                alias: During Nighttime → Set HVAC to Cooling Night Setpoint ({{ cooling_night_setpoint_c }}°C)
            default:
              - target:
                  entity_id: climate.nest_learning_thermostat
                data:
                  temperature: "{{ cooling_day_setpoint_c }}"
                  hvac_mode: cool
                action: climate.set_temperature
                alias: Set HVAC to Cooling Mode at {{ cooling_day_setpoint_c }}°C (Default Daytime)
        else:
          - alias: Apply Heating Strategy
            choose:
              - conditions:
                  - condition: or
                    conditions:
                      - alias: >-
                          Check If Forecast Low Temperature is Above Warm Threshold
                          (>= {{ forecast_low_warm_threshold_c }}°C)
                        condition: template
                        value_template: >-
                          {{ states('sensor.winnipeg_low_temperature') | float
                          >= forecast_low_warm_threshold_c }}
                      - alias: >-
                          Check If Forecast High Temperature is Above Warm Threshold
                          (>= {{ forecast_high_warm_threshold_c }}°C)
                        condition: template
                        value_template: >-
                          {{ states('sensor.winnipeg_high_temperature') | float
                          >= forecast_high_warm_threshold_c }}
                sequence:
                  - action: climate.turn_off
                    metadata: {}
                    data: {}
                    target:
                      entity_id: climate.nest_learning_thermostat
                    alias: Turn Off HVAC (Warm Weather Forecast)
                alias: When Weather Forecast is Warm → Turn Off HVAC (Heating Not Required)
              - conditions:
                  - condition: state
                    entity_id: binary_sensor.worktime_sensor
                    state: "on"
                  - condition: template
                    value_template: "{{ states('device_tracker.seunphone_unifi') != 'home' }}"
                    alias: Check If Seun is Away from Home
                sequence:
                  - target:
                      entity_id: climate.nest_learning_thermostat
                    data:
                      temperature: "{{ heating_work_setpoint_c }}"
                      hvac_mode: heat
                    action: climate.set_temperature
                    alias: Set HVAC to Heating Mode at {{ heating_work_setpoint_c }}°C
                alias: >-
                  During Worktime When Seun is Away → Set HVAC to Heating Work Setpoint
                  ({{ heating_work_setpoint_c }}°C)
              - conditions:
                  - alias: Check If Current Time is in Heating Evening Schedule
                    condition: template
                    value_template: >-
                      {{ now().strftime('%H:%M:%S') >=
                      heating_evening_start_time and now().strftime('%H:%M:%S') <
                      heating_night_start_time }}
                sequence:
                  - target:
                      entity_id: climate.nest_learning_thermostat
                    data:
                      temperature: "{{ heating_evening_setpoint_c }}"
                      hvac_mode: heat
                    action: climate.set_temperature
                    alias: Set HVAC to Heating Mode at {{ heating_evening_setpoint_c }}°C
                alias: During Evening Time → Set HVAC to Heating Evening Setpoint ({{ heating_evening_setpoint_c }}°C)
              - conditions:
                  - condition: template
                    alias: Check If Current Time is in Heating Night Schedule
                    value_template: >-
                      {{ now().strftime('%H:%M:%S') >= heating_night_start_time
                      or now().strftime('%H:%M:%S') < heating_day_start_time }}
                sequence:
                  - target:
                      entity_id: climate.nest_learning_thermostat
                    data:
                      temperature: "{{ heating_night_setpoint_c }}"
                      hvac_mode: heat
                    action: climate.set_temperature
                    alias: Set HVAC to Heating Mode at {{ heating_night_setpoint_c }}°C
                alias: During Nighttime → Set HVAC to Heating Night Setpoint ({{ heating_night_setpoint_c }}°C)
            default:
              - target:
                  entity_id: climate.nest_learning_thermostat
                data:
                  temperature: "{{ heating_day_setpoint_c }}"
                  hvac_mode: heat
                action: climate.set_temperature
                alias: Set HVAC to Heating Mode at {{ heating_day_setpoint_c }}°C (Default Daytime)
alias: Adjust Nest Thermostat
description: >-
  Adjust HVAC based on family status, weather forecast, outside temperature and
  a variety of other conditions.
